<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>Title</title>
</head>
<body>
<div layout:fragment="content">
  <h1>Subscriptions Page!</h1>
  <div>
    <h3>정기결제 리스트</h3>
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addSubModal">추가</button>
    <ul>
      <li th:each="sub : ${subscriptions}" th:attr="data-id=${sub.subId},
          data-catId=${sub.categories.catId},
          data-title=${sub.subTitle},
          data-amount=${sub.subAmount},
          data-payDate=${sub.subPayDate},
          data-periodUnit=${sub.subPeriodUnit},
          data-periodValue=${sub.subPeriodValue},
          data-notice=${sub.subNotice},
          data-isSub=${sub.isSub}">
        <span class="subscription-name"
              data-bs-toggle="modal"
              data-bs-target="#editSubModal">
          <span th:text = "${sub.categories.getCatName()}"></span>
          <span th:text="${sub.subTitle}"></span>
          <span th:text="'₩' + ${#numbers.formatInteger(sub.subAmount, 3, 'COMMA')}"></span>
          <span th:text="${sub.subPeriodValue} + ' ' + ${sub.subPeriodUnit}"></span>
          <span th:text="${sub.subPayDate} + '일'"></span>
          <span th:text="${sub.isSub()} ? '활성화' : '비활성화'"></span>
        </span>
        <button type="button" class="btn btn-sm btn-danger btn-delete">X</button>
      </li>
    </ul>
  </div>

  <!--add subscriptions-->
  <div class="modal fade" id="addSubModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="addSubForm" class="modal-content">
        <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
        <div class="modal-header">
          <h5 class="modal-title">정기 결제 추가</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">

          <!-- 카테고리 선택 -->
          <div class="mb-3">
            <label class="form-label">카테고리</label>
<!--            <select class="form-select" name="catId" id="catId" required>-->
<!--            스크롤을 사용하기 위한 높이 조절 ? 왜 안 되는거야?-->
            <select class="form-select" name="catId" id="catId" required
                    style="max-height: 2000px; overflow-y: auto;">
              <!-- 유저의 카테고리 + 디폴트 카테고리를 서버에서 내려줌 -->
              <option value="" selected disabled>카테고리를 선택하세요</option>
              <option th:each="cat : ${categories}" th:value="${cat.catId}" th:text="${cat.catName}"></option>
            </select>
          </div>

          <!-- 정기 결제 이름 -->
          <div class="mb-3">
            <label class="form-label">정기 결제 이름</label>
            <input type="text" class="form-control" name="subTitle" id="subTitle" required minlength="2">
          </div>

          <!-- 결제 금액 -->
          <div class="mb-3">
            <label class="form-label">결제 금액</label>
            <input type="number" class="form-control" name="subAmount" id="subAmount" min="0" required>
          </div>

          <!-- 결제날 (숫자 입력) -->
          <div class="mb-3">
            <label class="form-label">결제날 (Day)</label>
            <input type="number" class="form-control" name="subPayDate" id="subPayDate" min="1" max="31" required>
            <div class="form-text">1~31 사이의 숫자를 입력하세요</div>
          </div>

          <!-- 결제주기 -->
          <div class="mb-3">
            <label class="form-label">결제 주기</label>
            <select class="form-select" name="subPeriodUnit" id="subPeriodUnit" required>
              <option value="" selected disabled>주기를 선택하세요</option>
              <option value="DAY">일</option>
              <option value="WEEK">주</option>
              <option value="MONTH">월</option>
              <option value="YEAR">년</option>
            </select>
          </div>

          <!-- 정기 주기 값 -->
          <div class="mb-3">
            <label class="form-label">결제 주기 값</label>
            <input type="number" class="form-control" name="subPeriodValue" id="subPeriodValue" min="1" required>
            <div class="form-text">예: DAY + 3 → 3일마다 결제</div>
          </div>

          <!-- 알림 여부 -->
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="subNotice" id="subNotice">
            <label class="form-check-label" for="subNotice">결제 알림 받기</label>
          </div>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">추가</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        </div>
      </form>
    </div>
  </div><!--add subscription end-->

<!--subscription modify-->
  <div class="modal fade" id="editSubModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="editSubForm" class="modal-content">
        <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
        <input type="hidden" id="editSubId">
        <div class="modal-header">
          <h5 class="modal-title">정기 결제 수정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">

          <!-- 카테고리 선택 -->
          <div class="mb-3">
            <label class="form-label">카테고리</label>
            <select class="form-select" name="catId" id="editCatId" required
                    style="max-height: 200px; overflow-y: auto;">
              <!-- 유저의 카테고리 + 디폴트 카테고리를 서버에서 내려줌 -->
              <option value="" selected disabled>카테고리를 선택하세요</option>
              <option th:each="cat : ${categories}" th:value="${cat.catId}" th:text="${cat.catName}"></option>
            </select>
          </div>

          <!-- 정기 결제 이름 -->
          <div class="mb-3">
            <label class="form-label">정기 결제 이름</label>
            <input type="text" class="form-control" name="subTitle" id="editSubTitle" required minlength="2">
          </div>

          <!-- 결제 금액 -->
          <div class="mb-3">
            <label class="form-label">결제 금액</label>
            <input type="number" class="form-control" name="subAmount" id="editSubAmount" min="0" required>
          </div>

          <!-- 결제날 (숫자 입력) -->
          <div class="mb-3">
            <label class="form-label">결제날 (Day)</label>
            <input type="number" class="form-control" name="subPayDate" id="editSubPayDate" min="1" max="31" required>
            <div class="form-text">1~31 사이의 숫자를 입력하세요</div>
          </div>

          <!-- 결제주기 -->
          <div class="mb-3">
            <label class="form-label">결제 주기</label>
            <select class="form-select" name="subPeriodUnit" id="editSubPeriodUnit" required>
              <option value="" selected disabled>주기를 선택하세요</option>
              <option value="DAY">일</option>
              <option value="WEEK">주</option>
              <option value="MONTH">월</option>
              <option value="YEAR">년</option>
            </select>
          </div>

          <!-- 정기 주기 값 -->
          <div class="mb-3">
            <label class="form-label">결제 주기 값</label>
            <input type="number" class="form-control" name="subPeriodValue" id="editSubPeriodValue" min="1" required>
            <div class="form-text">예: DAY + 3 → 3일마다 결제</div>
          </div>

          <!-- 알림 여부 -->
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="subNotice" id="editSubNotice">
            <label class="form-check-label" for="editSubNotice">결제 알림 받기</label>
          </div>
          <!--활성/비활성 선택-->
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="isSub" id="editIsSub">
            <label class="form-check-label" for="editIsSub">활성/비활성</label>
          </div>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">수정</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        </div>
      </form>
    </div>
  </div><!--subscription modify end-->

  <script th:inline="javascript">
      const t = document.querySelector('meta[name="_csrf"]')?.content;
      const h = document.querySelector('meta[name="_csrf_header"]')?.content;
      const headers = { 'Content-Type': 'application/json' };
      if (t && h) headers[h] = t;

      document.addEventListener('DOMContentLoaded', () => {
          const addSubForm = document.getElementById("addSubForm");

          addSubForm.addEventListener("submit", async (e) => {
              e.preventDefault();

              // 입력값 수집
              const catId = document.getElementById("catId").value;
              const subTitle = document.getElementById("subTitle").value.trim();
              const subAmount = document.getElementById("subAmount")?.value || 0; // 금액 필드 있다면
              const subPayDate = document.getElementById("subPayDate").value;
              const subNotice = document.getElementById("subNotice")?.checked || false; // 체크박스로 만들면 true/false
              const subPeriodUnit = document.getElementById("subPeriodUnit").value;
              const subPeriodValue = document.getElementById("subPeriodValue").value;
              const isSub = true; // 기본값 true (활성화)

              // 검증
              if (!catId) return alert("카테고리를 선택하세요.");
              if (!subTitle) return alert("정기 결제 이름을 입력하세요.");
              if (subAmount < 0) return alert("결제 금액은 0원 이상이어야 합니다.");
              if (!subPayDate || subPayDate < 1 || subPayDate > 31) return alert("결제 날짜는 1~31 사이여야 합니다.");
              if (!subPeriodUnit) return alert("결제 주기를 선택하세요.");
              if (!subPeriodValue || subPeriodValue < 1) return alert("정기 주기 값을 입력하세요.");

              // 요청 payload
              const payload = {
                  catId: parseInt(catId),
                  subTitle,
                  subAmount: parseInt(subAmount),
                  subPayDate: parseInt(subPayDate),
                  subNotice,
                  subPeriodUnit,
                  subPeriodValue: parseInt(subPeriodValue),
                  isSub
              };

              try {
                  const res = await fetch("/subscriptions/addSub", {
                      method: "POST",
                      headers: {
                          "Content-Type": "application/json",
                          "X-CSRF-TOKEN": document.querySelector("meta[name='_csrf']").content
                      },
                      credentials: "same-origin",
                      body: JSON.stringify(payload)
                  });

                  const data = await res.json().catch(() => ({}));

                  if (res.ok) {
                      alert("정기 결제가 추가되었습니다.");
                      window.location.replace('/subscriptions/subMain');
                  } else {
                      alert(data.message || "추가 실패");
                  }
              } catch (err) {
                  console.error(err);
                  alert("네트워크 오류 발생");
              }
          });

          // sub delete
          document.querySelectorAll(".btn-delete").forEach(btn => {
              btn.addEventListener("click", async (e) => {
                  const li = e.target.closest("li");
                  const subId = li.getAttribute("data-id");

                  if (!confirm("정말 삭제하시겠습니까?")) return;

                  try {
                      const res = await fetch(`/subscriptions/deleteSub/${subId}`, {
                          method: "DELETE",
                          headers,
                          credentials: "same-origin"
                      });

                      if (res.ok) {
                          li.remove(); // ✅ 뷰에서도 즉시 제거
                          alert("삭제되었습니다.");
                          window.location.replace('/subscriptions/subMain');
                      } else {
                          const data = await res.json();
                          alert(data.message || "삭제 실패");
                      }
                  } catch (err) {
                      console.error(err);
                      alert("네트워크 오류 발생");
                  }
              });
          });

          // subscription modify script
          const editForm = document.getElementById("editSubForm");

          document.querySelectorAll(".subscription-name").forEach(span => {
              span.addEventListener("click", () => {
                  const li = span.closest("li");
                  const subId = li.getAttribute("data-id");
                  const catId = li.getAttribute("data-catId"); // li에 data-catId 넣어놔야 함

                  // 서버에서 내려줄 때 data-*에 다 담아주는 게 가장 안정적
                  const subTitle = li.getAttribute("data-title");
                  const subAmount = li.getAttribute("data-amount"); // 숫자 그대로
                  const subPayDate = li.getAttribute("data-payDate");
                  const subPeriodUnit = li.getAttribute("data-periodUnit");
                  const subPeriodValue = li.getAttribute("data-periodValue");
                  const subNotice = li.getAttribute("data-notice") === "true";
                  const isSub = li.getAttribute("data-isSub") === "true";

                  // modal input 채우기
                  document.getElementById("editSubId").value = subId;
                  document.getElementById("editCatId").value = catId;
                  document.getElementById("editSubTitle").value = subTitle;
                  document.getElementById("editSubAmount").value = subAmount;
                  document.getElementById("editSubPayDate").value = subPayDate;
                  document.getElementById("editSubPeriodUnit").value = subPeriodUnit;
                  document.getElementById("editSubPeriodValue").value = subPeriodValue;
                  document.getElementById("editSubNotice").checked = subNotice;
                  document.getElementById("editIsSub").checked = isSub;
              });
          });

          // 수정 form submit
          editForm.addEventListener("submit", async (e) => {
              e.preventDefault();

              const subId = document.getElementById("editSubId").value;
              const catId = document.getElementById("editCatId").value;
              const subTitle = document.getElementById("editSubTitle").value.trim();
              const subAmount = document.getElementById("editSubAmount").value;
              const subPayDate = document.getElementById("editSubPayDate").value;
              const subPeriodUnit = document.getElementById("editSubPeriodUnit").value;
              const subPeriodValue = document.getElementById("editSubPeriodValue").value;
              const subNotice = document.getElementById("editSubNotice").checked;
              const isSub = document.getElementById("editIsSub").checked;

              const payload = {
                  catId: parseInt(catId),
                  subTitle,
                  subAmount,
                  subPayDate: parseInt(subPayDate),
                  subPeriodUnit,
                  subPeriodValue: parseInt(subPeriodValue),
                  subNotice,
                  isSub
              };

              try {
                  const res = await fetch(`/subscriptions/modifySub/${subId}`, {
                      method: "PUT",
                      headers: {
                          "Content-Type": "application/json",
                          "X-CSRF-TOKEN": document.querySelector("meta[name='_csrf']").content
                      },
                      credentials: "same-origin",
                      body: JSON.stringify(payload)
                  });

                  const data = await res.json().catch(() => ({}));

                  if (res.ok) {
                      alert("정기 결제가 수정되었습니다.");
                      window.location.replace('/subscriptions/subMain');
                  } else {
                      alert(data.message || "수정 실패");
                  }
              } catch (err) {
                  console.error(err);
                  alert("네트워크 오류 발생");
              }
          });
      });
  </script>
</div>
</body>
</html>