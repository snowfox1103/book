<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>포인트</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        .toolbar{gap:.5rem}
        .sort-link{text-decoration:none}
        .sort-arrow{font-size:.85em;margin-left:.25rem}
        .table-empty{padding:3rem 0;color:#6c757d}
        .num{text-align:end;font-variant-numeric:tabular-nums}
        .summary-num{letter-spacing:.3px}
    </style>
</head>
<body class="bg-light">

<div th:replace="~{fragments/nyjcommon :: header(active='points')}"></div>

<div class="container py-4">

    <!-- 상단 카드 -->
    <div class="card shadow-sm mb-3">
        <div class="card-body d-flex flex-wrap align-items-center toolbar">
            <h5 class="m-0 me-auto fw-semibold">포인트</h5>
        </div>

        <!-- 월 선택 / 전체기간 -->
        <div>
            <form class="d-flex align-items-center gap-2 mb-2" method="get" th:action="@{/point}">
                <input type="month" class="form-control form-control-sm" name="ym"
                       style="max-width:160px" th:value="${ym}">
                <button class="btn btn-sm btn-primary" type="submit">조회</button>
                <a class="btn btn-sm btn-outline-secondary" th:href="@{/point}">전체기간</a>
            </form>
        </div>

        <!-- 요약 카드 -->
        <div class="card mb-3 shadow-sm">
            <div class="card-body"
                 th:with="s=${summary},
                          earn=${s != null ? s.earnedPeriod : 0},
                          use=${s != null ? s.usedPeriod : 0},
                          curr=${s != null ? s.currentAll : 0},
                          endbal=${s != null ? s.balanceAtPeriodEnd : 0},
                          label=${s != null ? s.periodLabel : '전체기간'}">

                <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center">

                    <!-- 왼쪽: 현재 포인트 + 월말 잔액 -->
                    <div class="me-md-auto">
                        <div class="fw-bold small text-muted mb-1">현재 포인트 (전체)</div>
                        <div class="h3 mb-1 summary-num">
                            <span th:text="${#numbers.formatInteger(curr, 3, 'COMMA')}">0</span>
                        </div>
                        <div class="text-muted small text-nowrap d-inline-flex align-items-baseline gap-1" th:if="${ym}">
                            <span th:text="${label}">2025-07</span>
                            <span>말일 잔액:</span>
                            <span th:text="${#numbers.formatInteger(endbal, 3, 'COMMA')}">0</span>
                        </div>
                    </div>

                    <!-- 오른쪽: 적립 / 사용 / 증감 -->
                    <div class="ms-md-3 w-100 w-md-auto mt-3 mt-md-0 text-md-end">
                        <div class="small text-muted mb-1">
                            <span th:text="${label}">전체기간</span>
                        </div>

                        <div class="d-inline-block me-4">
                            <div class="small text-muted">적립 포인트</div>
                            <span th:text="${#numbers.formatInteger(earn, 3, 'COMMA')}">0</span>
                        </div>

                        <div class="d-inline-block me-4">
                            <div class="small text-muted">사용 포인트</div>
                            <span th:text="${#numbers.formatInteger(use, 3, 'COMMA')}">0</span>
                        </div>

                        <div class="d-inline-block">
                            <div class="small text-muted">증감 포인트</div>
                            <div class="h5 mb-0 summary-num"
                                 th:classappend="${(earn - use) >= 0} ? ' text-success' : ' text-danger'"
                                 th:text="${(earn - use) >= 0 ? '+' : ''} + ${#numbers.formatInteger(earn - use, 3, 'COMMA')}">+0
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- 정렬/방향/페이지크기 -->
        <div class="card-footer bg-white border-top-0 pt-0">
            <div class="d-flex flex-wrap align-items-center w-100 gap-2">

                <!-- 정렬 키 -->
                <div class="d-flex align-items-center gap-2">
                    <a class="btn btn-sm btn-outline-secondary"
                       th:classappend="${sort}=='date' ? ' active' : ''"
                       th:href="@{/point(sort='date', dir=${dir}, page=${pageNum}, size=${size}, ym=${ym})}">날짜</a>

                    <a class="btn btn-sm btn-outline-secondary"
                       th:classappend="${sort}=='delta' ? ' active' : ''"
                       th:href="@{/point(sort='delta', dir=${dir}, page=${pageNum}, size=${size}, ym=${ym})}">변동액</a>

                    <a class="btn btn-sm btn-outline-secondary"
                       th:classappend="${sort}=='type' ? ' active' : ''"
                       th:href="@{/point(sort='type', dir=${dir}, page=${pageNum}, size=${size}, ym=${ym})}">구분</a>
                </div>

                <!-- 정렬 방향 토글 + 페이지 크기 -->
                <div class="d-flex align-items-center gap-2 ms-auto">
                    <a class="btn btn-sm btn-outline-secondary"
                       th:href="@{/point(sort=${sort},
                                dir=${#strings.equalsIgnoreCase(dir,'asc') ? 'desc' : 'asc'},
                                page=${pageNum}, size=${size}, ym=${ym})}">
                        <span th:text="${#strings.equalsIgnoreCase(dir,'asc') ? '오름차순(▲)' : '내림차순(▼)'}">내림차순(▼)</span>
                    </a>

                    <form th:action="@{/point}" method="get" class="d-inline-flex align-items-center">
                        <input type="hidden" name="sort" th:value="${sort}"/>
                        <input type="hidden" name="dir" th:value="${dir}"/>
                        <input type="hidden" name="page" th:value="${pageNum}"/>
                        <input type="hidden" name="ym" th:value="${ym}"/>
                        <select name="size" class="form-select form-select-sm w-auto" onchange="this.form.submit()">
                            <option th:value="10" th:selected="${size==10}">10</option>
                            <option th:value="20" th:selected="${size==20}">20</option>
                            <option th:value="50" th:selected="${size==50}">50</option>
                            <option th:value="100" th:selected="${size==100}">100</option>
                        </select>
                        <noscript><button class="btn btn-sm btn-outline-secondary ms-1">적용</button></noscript>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 목록 -->
    <div class="table-responsive bg-white rounded shadow-sm">
        <table class="table align-middle mb-0">
            <thead class="table-light">
            <tr>
                <th style="width:180px;"
                    th:with="field='date', isCurr=${sort==field}, nextDir=${isCurr and dir=='asc' ? 'desc' : 'asc'}">
                    <a class="sort-link" th:href="@{/point(page=${pageNum}, size=${size}, sort=${field}, dir=${nextDir}, ym=${ym})}">날짜</a>
                    <span class="sort-arrow" th:if="${isCurr}" th:text="${dir=='asc' ? '▲' : '▼'}"></span>
                </th>
                <th style="width:120px;"
                    th:with="field='type', isCurr=${sort==field}, nextDir=${isCurr and dir=='asc' ? 'desc' : 'asc'}">
                    <a class="sort-link" th:href="@{/point(page=${pageNum}, size=${size}, sort=${field}, dir=${nextDir}, ym=${ym})}">구분</a>
                    <span class="sort-arrow" th:if="${isCurr}" th:text="${dir=='asc' ? '▲' : '▼'}"></span>
                </th>
                <th>메모</th>
                <th class="text-end" style="width:160px;"
                    th:with="field='delta', isCurr=${sort==field}, nextDir=${isCurr and dir=='asc' ? 'desc' : 'asc'}">
                    <a class="sort-link" th:href="@{/point(page=${pageNum}, size=${size}, sort=${field}, dir=${nextDir}, ym=${ym})}">변동액</a>
                    <span class="sort-arrow" th:if="${isCurr}" th:text="${dir=='asc' ? '▲' : '▼'}"></span>
                </th>
                <th class="text-end" style="width:160px;">잔액</th>
            </tr>
            </thead>

            <tbody>
            <tr th:if="${page.totalElements == 0}">
                <td colspan="5" class="text-center table-empty">포인트 내역이 없습니다.</td>
            </tr>

            <tr th:each="p : ${page.content}">
                <td th:text="${
                    p.pointStartDate == null ? '-' :
                    (p.pointStartDate instanceof T(java.time.LocalDateTime)
                      ? #temporals.format(p.pointStartDate, 'yyyy-MM-dd HH:mm')
                      : #temporals.format(p.pointStartDate, 'yyyy-MM-dd'))
                }">-</td>

                <td th:with="t=${p.pointType}"
                    th:text="${t == null ? '-' : (#strings.equalsIgnoreCase(t.toString(),'EARN') ? '적립' : '사용')}">-</td>

                <td th:text="${p.pointReason != null ? p.pointReason : '-'}">-</td>

                <td class="num">
                  <span th:with="t=${p.pointType}, isEarn=${t != null and #strings.equalsIgnoreCase(t.toString(),'EARN')}"
                        th:class="${isEarn} ? 'text-success' : 'text-danger'"
                        th:text="${(isEarn ? '+' : '-') + (p.pointAmount != null ? #numbers.formatInteger(p.pointAmount,0,'COMMA') : '0')}">0</span>
                </td>

                <td class="num"
                    th:text="${p.runningBalance != null ? #numbers.formatInteger(p.runningBalance,0,'COMMA')
                      : (p.balance != null ? #numbers.formatInteger(p.balance,0,'COMMA') : '-') }">-</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 블록 페이지네이션 (컨트롤러 제공 변수 사용: now/startPage/endPage/prevPage/nextPage … 전부 1-based) -->
    <nav class="mt-3" th:if="${page.totalPages > 1}">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${hasPrevBlock}? '' : ' disabled'">
                <a class="page-link"
                   th:href="@{/point(page=${prevPage}, size=${size}, sort=${sort}, dir=${dir}, ym=${ym})}">이전</a>
            </li>

            <li class="page-item" th:each="i : ${#numbers.sequence(startPage, endPage)}"
                th:classappend="${i == now} ? ' active' : ''">
                <a class="page-link" th:text="${i}"
                   th:href="@{/point(page=${i}, size=${size}, sort=${sort}, dir=${dir}, ym=${ym})}">1</a>
            </li>

            <li class="page-item" th:classappend="${hasNextBlock}? '' : ' disabled'">
                <a class="page-link"
                   th:href="@{/point(page=${nextPage}, size=${size}, sort=${sort}, dir=${dir}, ym=${ym})}">다음</a>
            </li>
        </ul>
    </nav>
</div>

<div th:replace="~{fragments/common :: alert}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
