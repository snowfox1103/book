<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>프로젝트1 - 로그인</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/login.css}">
  <link rel="stylesheet" th:href="@{/css/common.css}">
</head>
<body>
<div th:replace="~{fragments/common :: header(active='board')}"></div>
<div class="login-container">
  <div class="page-container">
    <!-- 첫 번째 페이지 -->
    <div class="first-page">
      <div class="first-page-content">
        <!-- 이미지 슬라이더 -->
        <div class="image-slider">
          <img id="slider-image" th:src="@{/images/sample-img.png}">
          <div class="button-wrap">
            <button class="prev">&lt;</button>
            <button class="next">&gt;</button>
          </div>
        </div>

        <!-- 로그인 영역 -->
        <div class="right-side">
          <article class="login-sec">
            <form th:action="@{/users/login}" method="post">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <input id="userId" type="text" name="username" placeholder="아이디" required>
              <input id="userPw" type="password" name="password" placeholder="비밀번호" required>
              <button type="submit" id="loginBtn">로그인</button>
              <ul>
                <li><a href="#" data-bs-toggle="modal" data-bs-target="#idSearchModal">아이디 찾기</a></li>
                <li><a href="#" data-bs-toggle="modal" data-bs-target="#pwSearchModal">비밀번호 찾기</a></li>
                <li><a href="/users/userRegister">회원가입</a></li>
                <li><a href="#" data-bs-toggle="modal" data-bs-target="#resendModal">인증메일 재전송</a></li>
              </ul>
            </form>
          </article>

          <!-- 자주 찾는 기능 -->
          <article class="use-sec">
            <p>자주 찾는 기능</p>
            <div class="use-boxes">
              <button class="use1 use-box">정기 결제</button>
              <button class="use2 use-box">예산 설정</button>
              <button class="use3 use-box">소비 분석</button>
            </div>
          </article>
        </div>
      </div>
    </div>

    <!-- 두 번째 페이지 -->
    <div class="second-page">
      <aside class="second-page-text">
        <h1>정기 결제를 한 번에</h1>
        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit...</p>
      </aside>
      <aside class="second-page-image">
        <img th:src="@{/images/auto-pay-img.png}">
      </aside>
    </div>

    <!-- 세 번째 페이지 -->
    <div class="third-page">
      <img th:src="@{/images/graph.jpg}">
      <aside class="third-page-text">
        <h1>가계부를 한 눈에</h1>
        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit...</p>
      </aside>
    </div>
  </div>

  <!-- 푸터 -->
  <footer>
    <ul>
      <li><a href="#">about us</a></li>
      <li><a href="#">licenses</a></li>
      <li><a href="#">공지사항</a></li>
    </ul>
  </footer>
</div>

<!-- 모달: 아이디 찾기 -->
<div class="modal fade" id="idSearchModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="idSearchForm">
        <div class="modal-header">
          <h5 class="modal-title">아이디 찾기</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input type="text" name="realName" placeholder="이름" required class="form-control">
          </div>
          <div class="mb-3">
            <input type="email" name="email" placeholder="이메일" required class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" id="idSearchBtn" class="btn btn-primary">아이디 찾기</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 모달: 비밀번호 찾기 -->
<div class="modal fade" id="pwSearchModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="pwSearchForm">
        <div class="modal-header">
          <h5 class="modal-title">비밀번호 찾기</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input type="text" name="userId" placeholder="아이디" required class="form-control">
          </div>
          <div class="mb-3">
            <input type="email" name="email" placeholder="이메일" required class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" id="pwSearchBtn" class="btn btn-primary">비밀번호 찾기</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 모달: 인증 메일 재전송 -->
<div class="modal fade" id="resendModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="resendForm">
        <div class="modal-header">
          <h5 class="modal-title">인증 메일 재전송</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input type="email" name="email" placeholder="이메일" required class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" id="resendBtn" class="btn btn-success">메일 보내기</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script th:inline="javascript">
    const error = /*[[${param.error}]]*/ null;
    console.log("error param:", error); // 디버깅용

    if (error === 'disabled') {
        alert('이메일 인증 후에 로그인할 수 있습니다.');
    } else if (error) {
        alert('아이디 또는 비밀번호가 잘못되었습니다.');
    }

    const loggedOut = /*[[${param.logout}]]*/ null;
    console.log("logout param:", loggedOut); // 디버깅용

    if (loggedOut) {
        alert('로그아웃 되었습니다.');
    }

    // 이미지 슬라이더
    const images = [
        /*[[@{/images/sample-img.png}]]*/,
        /*[[@{/images/cal.jpg}]]*/,
        /*[[@{/images/flower.jpg}]]*/,
        /*[[@{/images/graph.jpg}]]*/
    ];
    let currentIndex = 0;
    const imgTag = document.getElementById('slider-image');

    document.querySelector(".prev").addEventListener('click',()=>{
        currentIndex = (currentIndex-1+images.length)%images.length;
        imgTag.src = images[currentIndex];
    });
    document.querySelector(".next").addEventListener('click',()=>{
        currentIndex = (currentIndex+1)%images.length;
        imgTag.src = images[currentIndex];
    });
</script>

<script>
    // CSRF 헤더
    const t = document.querySelector('meta[name="_csrf"]')?.content;
    const h = document.querySelector('meta[name="_csrf_header"]')?.content;
    const headers = {'Content-Type':'application/json'};
    if(t && h) headers[h] = t;

    // 아이디 찾기
    document.getElementById("idSearchBtn").addEventListener("click", async ()=>{
        const form = document.getElementById("idSearchForm");
        const realName = form.realName.value.trim();
        const email = form.email.value.trim();
        if(!realName || !email){alert('이름과 이메일 입력'); return;}
        await fetch('/users/idSearch',{method:'POST',headers,body:JSON.stringify({realName,email})});
        alert("아이디 찾기 요청 완료");
    });

    // 비밀번호 찾기
    document.getElementById("pwSearchBtn").addEventListener("click", async ()=>{
        const form = document.getElementById("pwSearchForm");
        const userId = form.userId.value.trim();
        const email = form.email.value.trim();
        if(!userId || !email){alert('아이디와 이메일 입력'); return;}
        await fetch('/users/pwSearch',{method:'POST',headers,body:JSON.stringify({userId,email})});
        alert("비밀번호 찾기 요청 완료");
    });

    // 인증메일 재전송
    document.getElementById("resendBtn").addEventListener("click", async ()=>{
        const form = document.getElementById("resendForm");
        const email = form.email.value.trim();
        if(!email){alert('이메일 입력'); return;}
        await fetch('/users/resend',{method:'POST',headers,body:JSON.stringify({email})});
        alert("인증 메일 재전송 요청 완료");
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
