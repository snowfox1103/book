<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>가계북 - 로그인</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/login.css}">
</head>
<body class="bg-light">
<div class="login-box-container">
  <!-- 로그인 박스 -->
  <div class="login-box mx-auto">
    <!-- 로고 + 슬로건 -->
    <div class="text-center mb-4">
      <img src="/images/logo.png" alt="가계북 로고" class="login-logo mb-2">
      <h5 class="text-muted">한눈에 보는 소비 관리, <span class="fw-bold">가계북</span></h5>
    </div>

    <form th:action="@{/users/login}" method="post">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

      <div class="mb-3">
        <input type="text" name="username" class="form-control form-control-lg" placeholder="아이디" required>
      </div>

      <div class="mb-3">
        <input type="password" name="password" class="form-control form-control-lg" placeholder="비밀번호" required>
      </div>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" name="remember-me" id="rememberMe">
        <label class="form-check-label" for="rememberMe">자동 로그인</label>
      </div>

      <button type="submit" class="btn btn-primary w-100 btn-md mb-3">로그인</button>

      <!-- 소셜 로그인 구분선 -->
      <div class="divider-with-text my-3">
        <span>소셜 로그인</span>
      </div>

      <!-- 소셜 로그인 버튼들 -->
      <div class="d-flex justify-content-center gap-3 mb-3">
        <a href="/oauth2/authorization/kakao" class="kakao-btn">
          <img src="/images/kakao_logo.png" alt="카카오 로그인">
        </a>
      </div>

      <!-- 아이디/비밀번호/회원가입 링크 -->
      <div class="text-center small">
        <a href="#" data-bs-toggle="modal" data-bs-target="#idSearchModal">아이디 찾기</a> |
        <a href="#" data-bs-toggle="modal" data-bs-target="#pwSearchModal">비밀번호 찾기</a> |
        <a href="/users/userRegister">회원가입</a>
      </div>
    </form>
  </div>
</div>

<!-- 모달: 아이디 찾기 -->
<div class="modal fade" id="idSearchModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="idSearchForm">
        <div class="modal-header">
          <h5 class="modal-title">아이디 찾기</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input type="text" name="realName" placeholder="이름" required class="form-control">
          </div>
          <div class="mb-3">
            <input type="email" name="email" placeholder="이메일" required class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="idSearchBtn" class="btn btn-primary">아이디 찾기</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 모달: 비밀번호 찾기 -->
<div class="modal fade" id="pwSearchModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="pwSearchForm">
        <div class="modal-header">
          <h5 class="modal-title">비밀번호 찾기</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input type="text" name="userId" placeholder="아이디" required class="form-control">
          </div>
          <div class="mb-3">
            <input type="email" name="email" placeholder="이메일" required class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="pwSearchBtn" class="btn btn-primary">비밀번호 찾기</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    const error = /*[[${param.error}]]*/ null;
    if (error === 'disabled') {
        alert('이메일 인증 후에 로그인할 수 있습니다.');
    } else if (error) {
        alert('아이디 또는 비밀번호가 잘못되었습니다.');
    }

    const loggedOut = /*[[${param.logout}]]*/ null;
    if (loggedOut) {
        alert('로그아웃 되었습니다.');
    }

    const message = /*[[${message}]]*/ null;
    if (message) {
        alert('이메일을 확인해주세요.');
    }

    const msg = /*[[${msg}]]*/ null;
    if (msg) {
        alert(msg);
    }
</script>
<script>
    // CSRF 헤더
    const t = document.querySelector('meta[name="_csrf"]')?.content;
    const h = document.querySelector('meta[name="_csrf_header"]')?.content;
    const headers = {'Content-Type':'application/json'};
    if(t && h) headers[h] = t;

    // 아이디 찾기
    document.getElementById("idSearchBtn").addEventListener("click", async () => {
        const form = document.getElementById("idSearchForm");
        const realName = form.realName.value.trim();
        const email = form.email.value.trim();
        const btn = document.getElementById("idSearchBtn");

        if (!realName || !email) {
            alert('이름과 이메일 입력을 입력해주세요.');
            return;
        }

        btn.disabled = true;
        btn.textContent = '전송중...';

        try {
            const res = await fetch('/users/idSearch', {
                method: 'POST',
                headers,
                body: JSON.stringify({ realName, email })
            });

            const data = await res.json(); // JSON으로 메시지 받기

            if (res.ok) {
                alert(data.message); // "아이디 찾기 메일이 발송되었습니다."
                const modalEl = document.getElementById('idSearchModal');
                const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                modalInstance.hide();
                form.reset();
            } else {
                alert(data.message); // NOT_FOUND나 기타 에러 메시지 표시
            }
        } catch (e) {
            console.error(e);
            alert('에러가 발생했습니다.');
        } finally {
            // 버튼 상태 복원
            btn.disabled = false;
            btn.textContent = '아이디 찾기';
        }
    });

    // 비밀번호 찾기
    document.getElementById("pwSearchBtn").addEventListener("click", async () => {
        const form = document.getElementById("pwSearchForm");
        const userId = form.userId.value.trim();
        const email = form.email.value.trim();
        const btn = document.getElementById("pwSearchBtn");

        if (!userId || !email) {
            alert('아이디와 이메일을 입력해주세요.');
            return;
        }

        btn.disabled = true;
        btn.textContent = '전송중...';

        try {
            const res = await fetch('/users/pwSearch', {
                method: 'POST',
                headers,
                body: JSON.stringify({ userId, email })
            });

            const data = await res.json(); // JSON으로 파싱
            if (res.ok) {
                alert(data.message);
                const modalEl = document.getElementById('pwSearchModal');
                const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                modalInstance.hide();
                form.reset();
            } else {
                alert(data.message); // NOT_FOUND, INTERNAL_SERVER_ERROR일 때 메시지 표시
            }
        } catch (e) {
            console.error(e);
            alert('에러가 발생했습니다.');
        } finally {
            // 버튼 상태 복원
            btn.disabled = false;
            btn.textContent = '비밀번호 찾기';
        }
    });
</script>
</body>
</html>
