<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/nyjbasic.html}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div layout:fragment="content">
    <div class="all">
        <div class="page-container">
            <div class="page1">
                <aside class="page1-left">
                    <div class="remain">
                        <div class="money">
                            <div class="money-item">
                                <h2>잔액 :</h2>
                                <h1><th:block th:text="${T(java.lang.String).format('%,d', totals)} +'원'"></th:block></h1>
                            </div>
                            <div class="money-item">
                                <h2 th:text="${#temporals.month(#temporals.createNow())} + '월 수입 :'"></h2>
                                <h1><th:block th:text="${T(java.lang.String).format('%,d', income)}+' 원'" ></th:block></h1>
                            </div>
                            <div class="money-item">
                                <h2 th:text="${#temporals.month(#temporals.createNow())} + '월 출금 :'"></h2>
                                <h1><th:block th:text="${T(java.lang.String).format('%,d', uses)}+' 원'" ></th:block></h1>
                            </div>
                        </div>
                    </div>
                    <div class="recent">
                        <h4>정기 결제 내역</h4>
                        <table class="recent-list">
                            <thead>
                            <tr>
                                <th>이름</th>
                                <th>금액</th>
                                <th>결제일</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- 내역이 있을 경우 -->
                            <tr th:each="sub : ${subsList}" th:if="${!#lists.isEmpty(subsList)}">
                                <td th:text="${sub.subTitle}"></td>
                                <td th:text="${sub.subAmount}"></td>
                                <td th:text="${sub.subPayDate}"></td>
                            </tr>

                            <!-- 내역이 없을 경우 -->
                            <tr th:if="${#lists.isEmpty(subsList)}">
                                <td colspan="3" style="text-align: center;">정기결제 내역이 없습니다.</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </aside>

                <!-- 달력 -->
                <aside class="calendar">
                    <div class="cal-header">
                        <h1></h1>
                        <div class="cal-month">
                            <button type="button" id="prev-month">◀</button>
                            <p></p>
                            <button type="button" id="next-month">▶</button>
                        </div>
                    </div>
                    <div class="cal-body"></div>
                </aside>
            </div>

            <div class="page2">
                <div class="auto-pay-list">
                    <h2>최근 출금 내역</h2>
                    <table class="pay-table">
                        <thead>
                        <tr>
                            <th>날짜</th>
                            <th>항목</th>
                            <th>금액</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="dto : ${responseDTO.dtoList}"
                            th:if="${!#lists.isEmpty(responseDTO.dtoList)} and ${dto.userNo == users and dto.transInOut.name() == 'OUT'}">
                            <td>[[${#temporals.format(dto.transDate, 'MM-dd')}]]</td>
                            <td>[[${dto.transTitle}]]</td>
                            <td th:text="${T(java.lang.String).format('%,d', dto.transAmount)}"></td>
                        </tr>

                        <tr th:if="${#lists.isEmpty(responseDTO.dtoList)}">
                            <td colspan="3" style="text-align: center; color: gray; font-style: italic;">
                                출금 내역이 없습니다.
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="budget">
                    <h2>예산 현황</h2>
                    <table class="budget-table">
                        <thead>
                        <tr>
                            <th>카테고리</th>
                            <th>설정 금액</th>
                            <th>사용 금액</th>
                            <th>남은 금액</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- 예산이 있을 경우 -->
                        <tr th:each="b : ${monthlyBudgets}" th:if="${!#lists.isEmpty(monthlyBudgets)}">
                            <td th:text="${b.categoryName}"></td>
                            <td th:text="${T(java.lang.String).format('%,d', b.budgetAmount)} + '원'"></td>
                            <td th:text="${T(java.lang.String).format('%,d', b.budgetUsed)} + '원'"></td>
                            <td th:text="${T(java.lang.String).format('%,d', b.budgetAmount - b.budgetUsed)} + '원'"></td>
                        </tr>

                        <!-- 예산이 없을 경우 -->
                        <tr th:if="${#lists.isEmpty(monthlyBudgets)}">
                            <td colspan="4" style="text-align: center; color: gray; font-style: italic;">
                                이번 달 등록된 예산이 없습니다.
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="page3">
                <div class="category-graph">
                    <h2>이번 달 지출 카테고리</h2>
                    <canvas id="categoryChart" width="400" height="400"></canvas>
                </div>
                <div class="monthly-graph">
                    <h2>이번 달 입금/ 출금</h2>
                    <canvas id="monthlyChart" width="500" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <ul>
            <li><a href="#">about us</a></li>
            <li><a href="#">licenses</a></li>
            <li><a href="#">공지사항</a></li>
        </ul>
    </footer>

    <!-- 서버에서 내려준 값들 -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const thisMonthIncome = [[${income}]];
        const thisMonthUses = [[${uses}]];
        const categoryLabels = [[${categoryLabels}]];
        const categoryData = [[${categoryData}]];
        const userNo = [[${users}]];
        window.__dailyStats = [[${dailyStats}]];
        /*]]>*/
    </script>

    <script layout:fragment="script">
        let today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth();

        const calHeaderYear = document.querySelector(".cal-header h1");
        const calHeaderMonth = document.querySelector(".cal-month p");
        const calBody = document.querySelector(".cal-body");

        let dailyStats = window.__dailyStats || {};

        function renderCalendar(year, month) {
            if (!calHeaderYear || !calHeaderMonth || !calBody) return;

            calHeaderYear.textContent = year;
            calHeaderMonth.textContent = (month + 1) + "월";
            calBody.innerHTML = "";

            const week = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
            week.forEach((day, idx) => {
                const div = document.createElement("div");
                div.classList.add("grid-item", "day");
                div.textContent = day;
                if (idx === 0 || idx === 6) div.style.color = "red";
                calBody.appendChild(div);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement("div");
                empty.classList.add("grid-item");
                calBody.appendChild(empty);
            }

            for (let d = 1; d <= lastDate; d++) {
                const dateDiv = document.createElement("div");
                dateDiv.classList.add("grid-item");

                const dateNumber = document.createElement("div");
                dateNumber.classList.add("date-number");
                dateNumber.textContent = d;
                dateDiv.appendChild(dateNumber);

                const key = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                if (dailyStats[key]) {
                    const income = dailyStats[key].IN || 0;
                    const expense = dailyStats[key].OUT || 0;

                    if (income > 0) {
                        const incomeDiv = document.createElement("div");
                        incomeDiv.classList.add("total-income");
                        incomeDiv.textContent = "입금: " + income.toLocaleString('ko-KR') + "원";
                        dateDiv.appendChild(incomeDiv);
                    }

                    if (expense > 0) {
                        const expenseDiv = document.createElement("div");
                        expenseDiv.classList.add("total-expense");
                        expenseDiv.textContent = "출금: " + expense.toLocaleString('ko-KR') + "원";
                        dateDiv.appendChild(expenseDiv);
                    }
                }

                if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                    dateDiv.classList.add("today");
                }

                calBody.appendChild(dateDiv);
            }
        }

        // 초기 렌더링
        renderCalendar(currentYear, currentMonth);

        // AJAX로 다른 달 데이터 가져오기
        function fetchDailyStats(year, month) {
            fetch(`/mainPage/dailyStats?year=${year}&month=${month+1}&userNo=${userNo}`)
                .then(res => res.json())
                .then(data => {
                    dailyStats = data;
                    renderCalendar(year, month);
                });
        }

        document.getElementById("prev-month")?.addEventListener("click", () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            fetchDailyStats(currentYear, currentMonth);
        });

        document.getElementById("next-month")?.addEventListener("click", () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            fetchDailyStats(currentYear, currentMonth);
        });

        // 이번 달 수입/지출 막대
        const monthlyCtx = document.getElementById("monthlyChart").getContext("2d");
        new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: ['이번 달'],
                datasets: [
                    { label: '수입', data: [thisMonthIncome], backgroundColor: 'rgba(54, 162, 235, 0.6)' },
                    { label: '지출', data: [thisMonthUses], backgroundColor: 'rgba(255, 99, 132, 0.6)' }
                ]
            },
            options: {
                responsive: false,
                plugins: {
                    tooltip: { callbacks: { label: c => c.dataset.label + ': ' + c.raw.toLocaleString() + '원' } },
                    legend: { position: 'bottom' }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { callback: v => v.toLocaleString() + '원' } }
                }
            }
        });

        // 이번 달 지출 카테고리 도넛
        const categoryCtx = document.getElementById("categoryChart").getContext("2d");
        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: categoryLabels,
                datasets: [{
                    data: categoryData,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(153, 102, 255, 0.6)',
                        'rgba(255, 159, 64, 0.6)',
                        'rgba(100, 149, 237, 0.6)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: false,
                plugins: {
                    tooltip: { callbacks: { label: c => c.label + ': ' + c.raw.toLocaleString() + '원' } },
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true, pointStyle: 'circle', boxWidth: 10, padding: 10 }
                    }
                }
            }
        });
    </script>
</div>
</body>
</html>
