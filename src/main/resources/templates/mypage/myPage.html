<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>Title</title>
</head>
<body>
<div layout:fragment="content">
  <div>
    <h1>My Page!</h1>
  </div>
  <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#emailChangeModal">
    이메일 변경
  </button>
  <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#pwdChangeModal">
    비밀번호 변경
  </button>
<!--  회원탈퇴 form-->
  <form action="/mypage/userUnregister" method="post" onsubmit="return confirm('정말 탈퇴하시겠어요?');">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    <button type="submit" class="btn btn-danger">회원 탈퇴</button>
  </form>
  <div>
    <h3>카테고리 리스트</h3>
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">추가</button>
    <ul>
      <li th:each="cat : ${categories}"
          th:attr="data-id=${cat.catId},data-name=${cat.catName}">
        <!-- 카테고리 이름 자체에 클릭 이벤트 -->
        <span class="category-name"
              data-bs-toggle="modal"
              data-bs-target="#editCategoryModal"
              th:text="${cat.catName}"></span>
        <button type="button" class="btn btn-sm btn-danger btn-delete">X</button>
      </li>
    </ul>
  </div>

<!--email modify-->
  <div class="modal fade" id="emailChangeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="emailChangeForm" class="modal-content">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <div class="modal-header">
          <h5 class="modal-title">이메일 변경</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">현재 이메일</label>
            <input type="email" class="form-control" name="currentEmail" required>
          </div>
          <div class="mb-3">
            <label class="form-label">새 이메일</label>
            <input type="email" class="form-control" name="newEmail" required>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit" id="emailChangeBtn">변경</button>
        </div>
      </form>
    </div>
  </div> <!--email modify end-->

<!--  password modify-->
  <div class="modal fade" id="pwdChangeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="pwdChangeForm" class="modal-content">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <div class="modal-header">
          <h5 class="modal-title">비밀번호 변경</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">현재 비밀번호</label>
            <input type="password" class="form-control" name="currentPassword" required minlength="4">
          </div>
          <div class="mb-3">
            <label class="form-label">새 비밀번호</label>
            <input type="password" class="form-control" name="newPassword" required minlength="8">
            <div class="form-text">최소 8자 권장</div>
          </div>
          <div class="mb-3">
            <label class="form-label">새 비밀번호 확인</label>
            <input type="password" class="form-control" name="confirmPassword" required minlength="8">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit" id="pwdChangeBtn">변경</button>
        </div>
      </form>
    </div>
  </div> <!--  password modify end-->

<!--  add categories modal-->
  <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="addCategoryForm" class="modal-content">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <div class="modal-header">
          <h5 class="modal-title">카테고리 추가</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">카테고리 이름</label>
            <input type="text" class="form-control" name="categoryName" required minlength="4">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit" id="addCategoryBtn">추가</button>
        </div>
      </form>
    </div>
  </div> <!--  add category end-->

  <!--category modify-->
  <div class="modal fade" id="editCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="editCategoryForm" class="modal-content">
        <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
        <input type="hidden" name="catId" id="editCatId"/>
        <div class="modal-header">
          <h5 class="modal-title">카테고리 수정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">카테고리 이름</label>
            <input type="text" class="form-control" name="categoryName" id="editCategoryName" required minlength="4">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">수정</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        </div>
      </form>
    </div>
  </div><!--category modify end-->

  <script th:inline="javascript">
      const t = document.querySelector('meta[name="_csrf"]')?.content;
      const h = document.querySelector('meta[name="_csrf_header"]')?.content;
      const headers = { 'Content-Type': 'application/json' };
      if (t && h) headers[h] = t;

      document.addEventListener('DOMContentLoaded', () => {
          <!--  email modify script-->
          const emailForm = document.getElementById('emailChangeForm');
          if (!emailForm) {
              console.error('emailChangeForm not found');
              return;
          }

          emailForm.addEventListener('submit', async (e) => {
              e.preventDefault();

              const currentEmail = emailForm.currentEmail.value.trim();
              const newEmail = emailForm.newEmail.value.trim();

              if (!currentEmail)             return alert('현재 이메일을 입력하세요.');
              if (currentEmail === newEmail) return alert('새 이메일은 현재 이메일과 달라야 합니다.');

              try {
                  const res = await fetch('/mypage/userEmailModify', { // ← 컨트롤러 매핑에 맞춰 경로 확인!
                      method: 'POST',
                      headers,
                      credentials: 'same-origin', // 세션 쿠키 포함
                      body: JSON.stringify({ currentEmail, newEmail})
                  });

                  let data = {};
                  try {
                      const ct = res.headers.get('content-type') || '';
                      if (ct.includes('application/json')) data = await res.json();
                  } catch {}

                  if (res.ok) {
                      alert('이메일 변경되었습니다. 인증 메일을 다시 확인해 주세요');
                      window.location.replace('/users/login');
                  } else {
                      alert(data.message || '이메일 변경에 실패했습니다.');
                  }
              } catch (err) {
                  console.error(err);
                  alert('네트워크 오류가 발생했습니다.');
              }
          });

          // password modify script
          const pwform = document.getElementById('pwdChangeForm');
          if (!pwform) {
              console.error('pwdChangeForm not found');
              return;
          }

          pwform.addEventListener('submit', async (e) => {
              e.preventDefault();

              const currentPassword = pwform.currentPassword.value.trim();
              const newPassword     = pwform.newPassword.value.trim();
              const confirmPassword = pwform.confirmPassword.value.trim();

              if (!currentPassword)             return alert('현재 비밀번호를 입력하세요.');
              if (newPassword !== confirmPassword) return alert('새 비밀번호와 확인이 일치하지 않습니다.');
              if (currentPassword === newPassword) return alert('새 비밀번호는 현재 비밀번호와 달라야 합니다.');

              try {
                  const res = await fetch('/mypage/userPasswordModify', { // ← 컨트롤러 매핑에 맞춰 경로 확인!
                      method: 'POST',
                      headers,
                      credentials: 'same-origin', // 세션 쿠키 포함
                      body: JSON.stringify({ currentPassword, newPassword, confirmPassword })
                  });

                  let data = {};
                  try {
                      const ct = res.headers.get('content-type') || '';
                      if (ct.includes('application/json')) data = await res.json();
                  } catch {}

                  if (res.ok) {
                      alert('비밀번호가 변경되었습니다. 다시 로그인해 주세요.');
                      window.location.replace('/users/login?passwordChanged');
                  } else {
                      alert(data.message || '비밀번호 변경에 실패했습니다.');
                  }
              } catch (err) {
                  console.error(err);
                  alert('네트워크 오류가 발생했습니다.');
              }
          });

          // add category script
          const addCategoryForm = document.getElementById('addCategoryForm');
          if (!addCategoryForm) {
              console.error('addCategoryForm not found');
              return;
          }

          addCategoryForm.addEventListener('submit', async (e) => {
              e.preventDefault();

              const categoryName = addCategoryForm.categoryName.value.trim();

              if (!categoryName) return alert('추가할 카테고리 이름을 입력하세요.');

              try {
                  const res = await fetch('/mypage/category', { // ← 컨트롤러 매핑에 맞춰 경로 확인!
                      method: 'POST',
                      headers,
                      credentials: 'same-origin', // 세션 쿠키 포함
                      body: JSON.stringify({categoryName})
                  });

                  let data = {};
                  try {
                      const ct = res.headers.get('content-type') || '';
                      if (ct.includes('application/json')) data = await res.json();
                  } catch {}

                  if (res.ok) {
                      alert('카테고리 추가 되었습니다.');
                      window.location.replace('/mypage/myPage?addCategory');
                  } else {
                      alert(data.message || '카테고리 추가에 실패했습니다.');
                  }
              } catch (err) {
                  console.error(err);
                  alert('네트워크 오류가 발생했습니다.');
              }
          });

      //     category delete
          document.querySelectorAll(".btn-delete").forEach(btn => {
              btn.addEventListener("click", async (e) => {
                  const li = e.target.closest("li");
                  const catId = li.getAttribute("data-id");

                  if (!confirm("정말 삭제하시겠습니까?")) return;

                  try {
                      const res = await fetch(`/mypage/category/${catId}`, {
                          method: "DELETE",
                          headers,
                          credentials: "same-origin"
                      });

                      if (res.ok) {
                          li.remove(); // ✅ 뷰에서도 즉시 제거
                          alert("삭제되었습니다.");
                      } else {
                          const data = await res.json();
                          alert(data.message || "삭제 실패");
                      }
                  } catch (err) {
                      console.error(err);
                      alert("네트워크 오류 발생");
                  }
              });
          });

          const editForm = document.getElementById("editCategoryForm");
          const editCatId = document.getElementById("editCatId");
          const editCategoryName = document.getElementById("editCategoryName");

          // 카테고리 이름 클릭 시 모달에 값 채워넣기
          document.querySelectorAll(".category-name").forEach(span => {
              span.addEventListener("click", (e) => {
                  const li = e.target.closest("li");
                  editCatId.value = li.getAttribute("data-id");
                  editCategoryName.value = li.getAttribute("data-name");
              });
          });

          // 수정 form submit 처리
          editForm.addEventListener("submit", async (e) => {
              e.preventDefault();

              const catId = editCatId.value;
              const categoryName = editCategoryName.value.trim();
              if (!categoryName) return alert("이름을 입력하세요.");

              try {
                  const res = await fetch(`/mypage/category/${catId}`, {
                      method: "PUT",
                      headers: {
                          "Content-Type": "application/json",
                          "X-CSRF-TOKEN": document.querySelector("meta[name='_csrf']").content
                      },
                      credentials: "same-origin",
                      body: JSON.stringify({ categoryName })
                  });

                  const data = await res.json().catch(() => ({}));

                  if (res.ok) {
                      alert("수정되었습니다.");
                      window.location.reload();
                  } else {
                      alert(data.message || "수정 실패");
                  }
              } catch (err) {
                  console.error(err);
                  alert("네트워크 오류 발생");
              }
          });
      });
  </script>
</div>
</body>
</html>