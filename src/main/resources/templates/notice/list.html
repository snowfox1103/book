<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>공지사항</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        .sort-link{ text-decoration:none }
        .sort-arrow{ font-size:.85em; margin-left:.25rem }
        .toolbar { gap:.5rem }
    </style>
</head>
<body class="bg-light">

<!-- 공통 헤더 -->
<div th:replace="~{fragments/common :: header(active='notice')}"></div>

<div class="container py-4">

    <!-- 상단 헤더 카드: 제목 + (표시/새 공지) -->
    <div class="card shadow-sm mb-3">
        <div class="card-body d-flex flex-wrap align-items-center toolbar">
            <!-- 페이지 제목 -->
            <h5 class="m-0 me-auto fw-semibold">공지사항</h5>

            <!-- 페이지 크기 -->
            <form th:action="@{/notice}" method="get" class="d-inline-flex align-items-center gap-2">
                <input type="hidden" name="sort" th:value="${sort}"/>
                <input type="hidden" name="dir"  th:value="${dir}"/>
                <select name="size" class="form-select form-select-sm w-auto" onchange="this.form.submit()">
                    <option th:value="10"  th:selected="${page.size==10}">10</option>
                    <option th:value="20"  th:selected="${page.size==20}">20</option>
                    <option th:value="50"  th:selected="${page.size==50}">50</option>
                    <option th:value="100" th:selected="${page.size==100}">100</option>
                </select>
                <noscript><button class="btn btn-sm btn-outline-secondary">적용</button></noscript>
            </form>

            <!-- 새 공지: 관리자만 -->
            <a class="btn btn-sm btn-primary" th:href="@{/notice/write}" sec:authorize="hasRole('ADMIN')">새 공지</a>
        </div>

        <!-- 정렬 버튼 행 (라벨 없음) -->
        <div class="card-footer bg-white border-top-0 pt-0">
            <div class="d-flex flex-wrap align-items-center gap-2">
                <a class="btn btn-sm btn-outline-secondary"
                   th:classappend="${sort}=='nBId' ? ' active' : ''"
                   th:href="@{/notice(sort='nBId', dir=${dir}, page=${page.number}, size=${page.size})}">
                    번호
                </a>
                <a class="btn btn-sm btn-outline-secondary"
                   th:classappend="${sort}=='nBTitle' ? ' active' : ''"
                   th:href="@{/notice(sort='nBTitle', dir=${dir}, page=${page.number}, size=${page.size})}">
                    제목
                </a>
                <a class="btn btn-sm btn-outline-secondary"
                   th:classappend="${sort}=='nBCreatedAt' ? ' active' : ''"
                   th:href="@{/notice(sort='nBCreatedAt', dir=${dir}, page=${page.number}, size=${page.size})}">
                    작성일
                </a>

                <!-- 오름/내림 토글 -->
                <a class="btn btn-sm btn-outline-secondary ms-auto"
                   th:href="@{/notice(sort=${sort}, dir=${#strings.equalsIgnoreCase(dir,'asc') ? 'desc' : 'asc'}, page=${page.number}, size=${page.size})}">
                    <span th:text="${#strings.equalsIgnoreCase(dir,'asc') ? '오름차순(▲)' : '내림차순(▼)'}">내림차순(▼)</span>
                </a>
            </div>
        </div>
    </div>

    <!-- 목록 -->
    <div class="table-responsive bg-white rounded shadow-sm">
        <table class="table align-middle mb-0">
            <thead class="table-light">
            <tr>
                <th style="width:110px;">
                    <a class="sort-link"
                       th:href="@{/notice(sort='nBId', dir=${(sort=='nBId' and #strings.equalsIgnoreCase(dir,'asc')) ? 'desc':'asc'}, page=${page.number}, size=${page.size})}">
                        번호
                    </a>
                    <span class="sort-arrow" th:text="${sort=='nBId' ? (#strings.equalsIgnoreCase(dir,'asc') ? '▲':'▼') : ''}"></span>
                </th>
                <th>
                    <a class="sort-link"
                       th:href="@{/notice(sort='nBTitle', dir=${(sort=='nBTitle' and #strings.equalsIgnoreCase(dir,'asc')) ? 'desc':'asc'}, page=${page.number}, size=${page.size})}">
                        제목
                    </a>
                    <span class="sort-arrow" th:text="${sort=='nBTitle' ? (#strings.equalsIgnoreCase(dir,'asc') ? '▲':'▼') : ''}"></span>
                </th>
                <th style="width:200px;">작성자</th>
                <th style="width:200px;">
                    <a class="sort-link"
                       th:href="@{/notice(sort='nBCreatedAt', dir=${(sort=='nBCreatedAt' and #strings.equalsIgnoreCase(dir,'asc')) ? 'desc':'asc'}, page=${page.number}, size=${page.size})}">
                        작성일
                    </a>
                    <span class="sort-arrow" th:text="${sort=='nBCreatedAt' ? (#strings.equalsIgnoreCase(dir,'asc') ? '▲':'▼') : ''}"></span>
                </th>
            </tr>
            </thead>

            <tbody>
            <tr th:if="${page.totalElements == 0}">
                <td colspan="4" class="text-center text-muted" style="padding:3rem 0;">등록된 공지가 없습니다.</td>
            </tr>

            <tr th:each="n : ${page.content}">
                <td th:text="${n.nBId}">1</td>
                <td>
                    <a th:href="@{|/notice/${n.nBId}|}" th:text="${n.nBTitle}">제목</a>
                </td>

                <!-- 작성자: userNo → 아이디 매핑(Map<Long,String> authorNames) -->
                <td th:text="${authorNames[n.userNo]}">admin</td>

                <!-- 작성일 -->
                <td th:text="${#temporals.format(n.nBCreatedAt, 'yyyy-MM-dd HH:mm')}">2025-09-25 10:30</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 페이지네이션 -->
    <nav class="mt-3" th:if="${page.totalPages > 1}">
        <ul class="pagination justify-content-center">

            <!-- 이전 블록 -->
            <li class="page-item" th:classappend="${hasPrevBlock} ? '' : ' disabled'">
                <a class="page-link"
                   th:href="@{/notice(page=${prevPage - 1}, size=${page.size}, sort=${sort}, dir=${dir})}">
                    이전
                </a>
            </li>

            <!-- 페이지 번호들 (startPage ~ endPage) -->
            <li class="page-item"
                th:each="i : ${#numbers.sequence(startPage, endPage)}"
                th:classappend="${i == now} ? ' active' : ''">
                <a class="page-link"
                   th:text="${i}"
                   th:href="@{/notice(page=${i - 1}, size=${page.size}, sort=${sort}, dir=${dir})}">
                    1
                </a>
            </li>

            <!-- 다음 블록 -->
            <li class="page-item" th:classappend="${hasNextBlock} ? '' : ' disabled'">
                <a class="page-link"
                   th:href="@{/notice(page=${nextPage - 1}, size=${page.size}, sort=${sort}, dir=${dir})}">
                    다음
                </a>
            </li>
        </ul>
    </nav>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
