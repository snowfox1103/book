<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${q.qBTitle}">문의 상세</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .preline { white-space: pre-line; word-break: break-word; }
        .clamp { line-height: 1.6; max-height: calc(1.6em * 2.35); overflow: hidden;
            -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 85%, rgba(0,0,0,0));
            mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 85%, rgba(0,0,0,0)); }
        .clamp.expanded { max-height: none; -webkit-mask-image: none; mask-image: none; }
        .clamp-more { display:inline-block; margin-top:.25rem; font-size:.875rem; text-decoration:underline; cursor:pointer; }
        .reply-footer { display:flex; align-items:center; justify-content:space-between; gap:.75rem; min-height:2rem; }
        .reply-actions { white-space:nowrap; }
        .reply-actions form { display:inline; margin:0; }
        .reply-actions .btn { padding:.25rem .6rem; }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">

    <a class="btn btn-outline-secondary mb-3" href="/qna">← 목록</a>

    <!-- 문의 본문 -->
    <div class="card mb-3">
        <div class="card-body">
            <h2 class="h5 d-flex align-items-center gap-2">
                <a th:href="@{|/qna/${q.qBId}|}" th:text="${q.qBTitle}">제목</a>
                <span th:if="${q.qBBlind}" class="badge bg-secondary">비공개</span>
            </h2>

            <!-- 본문 (개행 유지 + 더보기) -->
            <p id="qna-body" class="mt-3 preline clamp"
               th:text="${#strings.replace(#strings.replace(q.qBContent, '\r\n', '\n'), '\r', '\n')}">내용</p>
            <a class="clamp-more" href="javascript:void(0)" data-target="qna-body" onclick="toggleClamp(this)">더보기</a>

            <div class="text-muted small">
                작성: <span th:text="${#temporals.format(q.regDate, 'yyyy-MM-dd HH:mm')}"></span>
                · 수정: <span th:text="${#temporals.format(q.modDate, 'yyyy-MM-dd HH:mm')}"></span>
            </div>
        </div>
    </div>

    <!-- 작성자 or 관리자만: 수정/삭제 -->
    <div class="d-flex gap-2 mb-4" th:if="${canEdit}">
        <a th:href="@{|/qna/${q.qBId}/edit|}" class="btn btn-primary">수정</a>
        <form th:action="@{|/qna/${q.qBId}/delete|}" method="post"
              onsubmit="return confirm('삭제할까요?');">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button class="btn btn-danger" type="submit">삭제</button>
        </form>
    </div>

    <!-- 답변 목록 -->
    <h3 class="h6 mb-2">답변</h3>
    <div th:if="${#lists.isEmpty(replies)}" class="alert alert-secondary">등록된 답변이 없습니다.</div>

    <div th:each="r : ${replies}" class="card mb-2">
        <div class="card-body">
            <p th:attr="id=${'reply-'+r.rno}" class="mb-1 preline clamp"
               th:text="${#strings.replace(#strings.replace(r.replyText, '\r\n', '\n'), '\r', '\n')}">답변 내용</p>
            <a class="clamp-more" href="javascript:void(0)"
               th:attr="data-target=${'reply-'+r.rno}" onclick="toggleClamp(this)">더보기</a>

            <div class="reply-footer mt-1">
                <small class="text-muted">
                    <span th:text="${r.replyer}">작성자</span>
                    <span>·</span>
                    <span th:text="${#temporals.format(r.regDate, 'yyyy-MM-dd HH:mm')}">시각</span>
                </small>

                <!-- 관리자만 답변 편집/삭제 -->
                <div sec:authorize="hasRole('ADMIN')" class="reply-actions">
                    <button type="button" class="btn btn-outline-primary btn-sm me-1"
                            th:attr="data-edit='edit-'+${r.rno}" onclick="toggleEdit(this)">수정</button>
                    <form th:action="@{|/admin/qna/reply/${r.rno}/delete|}" method="post"
                          onsubmit="return confirm('이 답변을 삭제할까요?');">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" name="qBId" th:value="${q.qBId}">
                        <button class="btn btn-outline-danger btn-sm">삭제</button>
                    </form>
                </div>
            </div>

            <!-- 인라인 수정 폼 (관리자만) -->
            <form sec:authorize="hasRole('ADMIN')"
                  th:attr="id=${'edit-'+r.rno}"
                  th:action="@{|/admin/qna/reply/${r.rno}/edit|}"
                  method="post" class="mt-2 d-none">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" name="qBId" th:value="${q.qBId}">
                <textarea name="content" class="form-control mb-2" rows="3" th:text="${r.replyText}"></textarea>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-primary">저장</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary"
                            th:attr="data-edit='edit-'+${r.rno}" onclick="toggleEdit(this)">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 관리자 답변 등록 -->
    <div sec:authorize="hasRole('ADMIN')">
        <form th:action="@{|/admin/qna/${q.qBId}/reply|}" method="post" class="card mt-3">
            <div class="card-body">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <textarea name="content" class="form-control mb-2" rows="3" placeholder="관리자 답변"></textarea>
                <button class="btn btn-success">답변 등록</button>
            </div>
        </form>
    </div>

</div>

<script>
    function toggleClamp(a) {
        const id = a.getAttribute('data-target');
        const box = document.getElementById(id);
        const expanded = box.classList.toggle('expanded');
        a.textContent = expanded ? '접기' : '더보기';
    }
    function toggleEdit(el) {
        const id = el.getAttribute('data-edit');
        const box = document.getElementById(id);
        if (box) box.classList.toggle('d-none');
    }
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.clamp').forEach(function (wrap) {
            const more = wrap.parentElement.querySelector('.clamp-more');
            if (!more) return;
            const needs = wrap.scrollHeight - 2 > wrap.clientHeight;
            if (!needs) more.style.display = 'none';
        });
    });
</script>

</body>
</html>
