<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>승인 대기 스캔</title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        .table th,.table td{vertical-align:middle}
        .page-link{min-width:2.25rem;text-align:center}
    </style>
</head>
<body class="bg-light">

<!-- 공통 헤더 -->
<div th:replace="~{fragments/nyjcommon :: header(active='admin')}"></div>

<!-- 본문: list.html과 동일하게 container로 감싸 좌우 여백 고정 -->
<div class="container py-4">

    <h1 class="h3 mb-4">승인 대기 스캔</h1>

    <div th:if="${msg}" class="alert alert-success" th:text="${msg}"></div>

    <!-- 조회/생성/비우기 -->
    <div class="card mb-3">
        <div class="card-body d-flex flex-wrap gap-2 align-items-end">

            <!-- 연/월 이동 -->
            <form th:action="@{/admin/scan}" method="get" class="d-flex flex-wrap gap-2 align-items-end">
                <div>
                    <label class="form-label">연</label>
                    <input type="number" name="year" class="form-control" th:value="${year}">
                </div>
                <div>
                    <label class="form-label">월</label>
                    <input type="number" name="month" min="1" max="12" class="form-control" th:value="${month}">
                </div>
                <div>
                    <label class="form-label d-block">&nbsp;</label>
                    <button class="btn btn-outline-secondary">이동</button>
                </div>
            </form>

            <div class="ms-auto d-flex gap-2">
                <!-- 해당 월 스캔 -->
                <form th:action="@{/admin/scan/run}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="hidden" name="year"  th:value="${year}">
                    <input type="hidden" name="month" th:value="${month}">
                    <button class="btn btn-primary">해당 월 스캔(승인 대기 생성)</button>
                </form>

                <!-- 비우기 -->
                <form th:action="@{/admin/scan/clear}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="hidden" name="year"  th:value="${year}">
                    <input type="hidden" name="month" th:value="${month}">
                    <button class="btn btn-outline-secondary">비우기</button>
                </form>
            </div>

        </div>
    </div>

    <!-- 리스트 -->
    <div class="card">
        <div class="card-body table-responsive">
            <table class="table align-middle mb-0">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>사용자</th>
                    <th>적립률</th>
                    <th>포인트</th>
                    <th>연/월</th>
                    <th>사유</th>
                    <th>상태</th>
                    <th class="text-nowrap">액션</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${page == null or #lists.isEmpty(page.content)}">
                    <td colspan="8" class="text-center text-muted">데이터가 없습니다.</td>
                </tr>

                <tr th:each="p : ${page.content}">
                    <td th:text="${p.id}">0</td>
                    <td>
                        <div th:text="${p.username}">user</div>
                        <small class="text-muted" th:text="'(#' + ${p.userNo} + ')'">(#0)</small>
                    </td>
                    <td th:text="${p.ratePercent} + '%'">0%</td>
                    <td th:text="${p.points}">0</td>
                    <td th:text="${p.yearMonth}">0000-00</td>
                    <td th:text="${p.reason}">-</td>

                    <!-- 상태 뱃지 (enum → name() 문자열 비교) -->
                    <td>
            <span class="badge rounded-pill text-bg-secondary"
                  th:if="${p.status != null and p.status.name() == 'PENDING'}">대기</span>
                        <span class="badge rounded-pill text-bg-success"
                              th:if="${p.status != null and p.status.name() == 'APPROVED'}">승인</span>
                        <span class="badge rounded-pill text-bg-danger"
                              th:if="${p.status != null and p.status.name() == 'REJECTED'}">반려</span>
                        <span class="text-muted" th:if="${p.status == null}">-</span>
                    </td>

                    <!-- 액션: 승인/반려 (PENDING일 때만 활성) -->
                    <td class="text-nowrap">
                        <form th:action="@{|/admin/scan/approve/${p.id}|}" method="post" class="d-inline">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="year"  th:value="${year}">
                            <input type="hidden" name="month" th:value="${month}">
                            <button class="btn btn-success btn-sm"
                                    th:disabled="${p.status != null and p.status.name() != 'PENDING'}">승인</button>
                        </form>
                        <form th:action="@{|/admin/scan/reject/${p.id}|}" method="post" class="d-inline">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="year"  th:value="${year}">
                            <input type="hidden" name="month" th:value="${month}">
                            <button class="btn btn-outline-danger btn-sm"
                                    th:disabled="${p.status != null and p.status.name() != 'PENDING'}">반려</button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- 페이지네이션 -->
        <div class="card-footer bg-white">
            <nav th:if="${page != null and page.totalPages > 0}">
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item" th:classappend="${page.first} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{|/admin/scan?year=${year}&month=${month}&page=${page.number-1}|}">이전</a>
                    </li>
                    <li class="page-item" th:each="i : ${#numbers.sequence(0, page.totalPages-1)}"
                        th:classappend="${i==page.number} ? 'active'">
                        <a class="page-link"
                           th:text="${i+1}"
                           th:href="@{|/admin/scan?year=${year}&month=${month}&page=${i}|}">1</a>
                    </li>
                    <li class="page-item" th:classappend="${page.last} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{|/admin/scan?year=${year}&month=${month}&page=${page.number+1}|}">다음</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- 결제(커밋) 버튼: 우측 정렬 -->
    <div class="d-flex justify-content-end mt-3">
        <form th:action="@{/admin/scan/commit}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" name="year"  th:value="${year}">
            <input type="hidden" name="month" th:value="${month}">
            <button class="btn btn-primary btn-lg">결제하기</button>
        </form>
    </div>

</div><!-- /.container -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
